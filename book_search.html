<html>

<meta charset="UTF-8">

<head>
    <link rel="shortcut icon" href="./public/img/favicon.ico" type="image/x-icon" />
    <link rel="icon" href="./public/img/favicon.ico" type="image/x-icon" />

    <title>책잡이</title>

    <link rel="stylesheet" href="./public/css/base_css/reset.css">
    <link rel="stylesheet" href="./public/css/base_css/header.css">
    <link rel="stylesheet" href="./public/css/base_css/footer.css">
    <link rel="stylesheet" href="./public/css/serach_css/book_search.css">
    <link rel="stylesheet" href="./public/fonts/font.css">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="./src/js/includeHtml.js"></script>
    <script type="text/javascript" src="./src/js/completed.js"></script>
</head>

<body>
    <include-html target="./header.php" completed="headerCompleted"></include-html>

    <div id="book_search">
        <h1>독립출판물 검색</h1>
        <hr>
        <p>
            도서명, 저자, 출판사, 판매 서점명 등으로 도서를 검색할 수 있습니다.<br>
            특수문자는 검색어에서 제외되어서 검색됩니다.
        </p>

        <div class="find">
            <input type="text" id="keyword" placeholder="검색어를 입력해주세요.">
            <button class="searchBtn">검색하기</button>
            <button class="detailBtn">상세검색</button>
        </div>

        <div class="answer">
            <div></div>
            <ul class="result"></ul>
        </div>

    </div>
    <include-html target="./footer.html" completed="footerCompleted"></include-html>

    <script>
        includeHtml();

        let ajax_last_num = 0;
        let current_ajax_num = ajax_last_num;
        let isRun = false;

        $(".searchBtn").click(function () {
            if (!isRun) {
                alert('검색중입니다. 잠시만 기다려주세요.');
            }
            if (isRun == true) {
                return;
                alert('실패라고!');
            } else {
                isRun = true;
            }

            let _keyword = $("#keyword").val();
            if (_keyword.length == 0) {
                alert("키워드를 입력해주세요.");
            } else {
                $.ajax({
                    type: "GET",
                    url: "./book_result.php",
                    timeout: 10000,
                    data: ({ keyword: _keyword }),
                    cache: false,
                    dataType: "json",
                    beforeSend: function (request) {
                        ajax_last_num = ajax_last_num + 1;
                    },
                    success: function (data) {
                        isRun = false;
                        if (current_ajax_num == ajax_last_num - 1) {

                            if (data.length != 0) {
                                $.each(data, function (key, val) {
                                    $('.result').append(
                                        '<li><dl><dt><img src="./public/img/' + val.img + '"></dt><dd><p class="title"></a>' + val.b_title
                                        + '</p><p>' + val.writer + '</p></dd></dl></li>');
                                    $('.answer div').html('<div>' + data.length + '개의 검색결과</div>');
                                });
                            } else if (data.length == 0) {
                                alert('검색결과가 없습니다.');
                                $('.answer div').html('<div>0개의 검색결과</div>');
                            }
                        }
                    }
                    ,
                    error: function (xhr, textStatus, errorThrown) {
                        alert("검색 실패했습니다.");
                    }
                });
            }
            return false;
        });

    </script>
</body>

</html>